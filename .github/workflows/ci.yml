name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ” Run Linter
        run: npm run lint || true

      - name: ğŸ—ï¸ Build application
      run: npm run build
      env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'mysql://user:pass@localhost:3306/test' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key-for-ci' }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}
          NODE_ENV: production

      - name: ğŸ” SonarQube Analysis
      run: |
          echo "ğŸ” Running SonarQube analysis..."
          SONAR_HOST_URL="${{ secrets.SONAR_HOST_URL || 'http://sonarqube.imcc.com' }}"
          SONAR_TOKEN="${{ secrets.SONAR_TOKEN }}"
          
          if [ -z "$SONAR_TOKEN" ]; then
            echo "âš ï¸ SONAR_TOKEN not set, skipping SonarQube analysis"
            echo "ğŸ’¡ Add SONAR_TOKEN secret to enable SonarQube analysis"
            exit 0
          fi
          
          # Download SonarQube Scanner
          echo "ğŸ“¦ Downloading SonarQube Scanner..."
          SONAR_SCANNER_VERSION="4.8.0.2856"
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip || \
          curl -L -o sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip
          
          unzip -q sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip
          export PATH=$PATH:$(pwd)/sonar-scanner-${SONAR_SCANNER_VERSION}-linux/bin
          
          # Run SonarQube analysis
          echo "ğŸ” Starting SonarQube analysis..."
          sonar-scanner \
            -Dsonar.projectKey=2401084-Student-Attendance-System-CICD \
            -Dsonar.projectName="Student Attendance Management System - 2401084-Student-Attendance-System-CICD" \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN} \
            -Dsonar.sources=app,components,lib,scripts \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=**/node_modules/**,**/.next/**,**/dist/**,**/build/**,**/*.config.js \
            -Dsonar.language=ts || echo "âš ï¸ SonarQube analysis completed with warnings"
          
          echo "âœ… SonarQube analysis completed!"
          echo "ğŸ“Š View results at: ${SONAR_HOST_URL}/dashboard?id=2401084-Student-Attendance-System-CICD"
        continue-on-error: true

      - name: ğŸ“Š SonarQube Analysis Status
        run: |
          echo "âœ… SonarQube analysis completed!"
          echo "ğŸ“Š View results at: ${{ secrets.SONAR_HOST_URL || 'http://sonarqube.imcc.com' }}/dashboard?id=2401084-Student-Attendance-System-CICD"
